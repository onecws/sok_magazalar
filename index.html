<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>ŞOK Mağaza Rota Oluşturucu</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial; background:#eef2f5; margin:0; }
header { background:#004aad; color:white; text-align:center; padding:20px; font-size:24px; }
.container { max-width:900px; margin:auto; padding:20px; }

.filters { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:20px; }

input,select {
    padding:12px; border-radius:8px; border:1px solid #ccc; font-size:15px;
}

button {
    background:#004aad; color:white; padding:14px 20px; border:none; border-radius:8px;
    font-size:17px; cursor:pointer; margin-bottom:20px;
}
button:hover { background:#00347a; }

.store { background:white; padding:15px; border-radius:10px;
    box-shadow:0 2px 8px rgba(0,0,0,0.15); margin-bottom:12px;
}

.store b { font-size:18px; color:#004aad; }
.distance { font-size:13px; color:#666; }

</style>
</head>

<body>

<header>ŞOK Mağaza Listesi & Rota Oluştur</header>

<div class="container">

    <div class="filters">
        <input type="text" id="searchInput" placeholder="Mağaza, il, ilçe ara...">
        <select id="cityFilter"></select>
        <select id="districtFilter"></select>
    </div>

    <button onclick="createRoute()">Google Maps ile Rota Oluştur</button>

    <div id="storeList"></div>

</div>

<script>
let stores = [];
let filtered = [];

async function loadStores() {
    const res = await fetch("magazalar.json?nocache=" + Date.now());
    stores = await res.json();
    filtered = stores;

    fillCityFilter();
    fillDistrictFilter();
    renderStores();
}

function fillCityFilter() {
    const citySelect = document.getElementById("cityFilter");
    const cities = [...new Set(stores.map(s => s.city))];

    citySelect.innerHTML = "<option value=''>Tüm Şehirler</option>" +
        cities.map(c => `<option value="${c}">${c}</option>`).join("");

    citySelect.onchange = () => {
        filterAll();
    };
}

function fillDistrictFilter() {
    const districtSelect = document.getElementById("districtFilter");

    const districts = [...new Set(filtered.map(s => s.district))];

    districtSelect.innerHTML = "<option value=''>Tüm İlçeler</option>" +
        districts.map(d => `<option value="${d}">${d}</option>`).join("");

    districtSelect.onchange = () => {
        filterAll();
    };
}

function filterAll() {
    const q = document.getElementById("searchInput").value.toLowerCase();
    const city = document.getElementById("cityFilter").value;
    const district = document.getElementById("districtFilter").value;

    filtered = stores.filter(s =>
        (s.name.toLowerCase().includes(q) ||
         s.city.toLowerCase().includes(q) ||
         s.district.toLowerCase().includes(q)) &&
        (city ? s.city === city : true) &&
        (district ? s.district === district : true)
    );

    fillDistrictFilter();
    renderStores();
}

document.getElementById("searchInput").oninput = filterAll;

function renderStores() {
    document.getElementById("storeList").innerHTML =
        filtered.map(s => `
        <div class="store">
            <label style="display:flex; gap:10px; align-items:flex-start;">
                <input type="checkbox" class="storeChk" value="${s.latitude},${s.longitude}">
                <div>
                    <b>${s.name}</b><br>
                    ${s.city} / ${s.district}<br>
                    ${s.address}<br>
                    <span class="distance">${s.distance_km} km uzaklıkta</span>
                </div>
            </label>
        </div>
        `).join("");
}

function createRoute() {
    const selected = [...document.querySelectorAll(".storeChk:checked")]
        .map(ch => ch.value);

    if (selected.length < 2) {
        alert("Lütfen en az 2 mağaza seçin.");
        return;
    }

    const origin = selected[0];
    const destination = selected[selected.length - 1];
    const waypoints = selected.slice(1, -1).join("|");

    const url =
        `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&waypoints=optimize:true|${waypoints}`;

    window.open(url, "_blank");
}

loadStores();
</script>

</body>
</html>
