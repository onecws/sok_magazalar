<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Mağaza Listesi + Rota Oluşturucu</title>
<style>
body { font-family: Arial; padding: 20px; }
.store { padding: 10px; border-bottom: 1px solid #ccc; }
</style>
</head>

<body>

<h2>Mağaza Arama & Rota Oluşturma</h2>

<input type="text" id="search" placeholder="Mağaza / il / ilçe ara..." style="width:300px;"><br><br>

<select id="cityFilter"></select>
<select id="districtFilter"></select>
<br><br>

<button onclick="createRoute()">Google Maps Rota Oluştur</button>

<hr>

<div id="storeList"></div>

<script>
let stores = [];
let filtered = [];

async function loadStores() {
    const res = await fetch("magazalar.json");
    stores = await res.json();
    filtered = stores;

    loadCityFilter();
    renderStores();
}

function loadCityFilter() {
    const citySelect = document.getElementById("cityFilter");
    const cities = [...new Set(stores.map(s => s.city))];

    citySelect.innerHTML = "<option value=''>Tüm Şehirler</option>" +
      cities.map(c => `<option value='${c}'>${c}</option>`).join("");

    citySelect.onchange = () => {
        const city = citySelect.value;
        if (city) {
            filtered = stores.filter(s => s.city === city);
        } else {
            filtered = stores;
        }
        loadDistrictFilter();
        renderStores();
    };

    loadDistrictFilter();
}

function loadDistrictFilter() {
    const districtSelect = document.getElementById("districtFilter");
    const districts = [...new Set(filtered.map(s => s.district))];

    districtSelect.innerHTML = "<option value=''>Tüm İlçeler</option>" +
        districts.map(d => `<option value='${d}'>${d}</option>`).join("");

    districtSelect.onchange = () => {
        const district = districtSelect.value;
        if (district)
            filtered = filtered.filter(s => s.district === district);
        else
            filtered = stores;

        renderStores();
    };
}

document.getElementById("search").oninput = e => {
    const q = e.target.value.toLowerCase();
    filtered = stores.filter(s =>
        s.name.toLowerCase().includes(q) ||
        s.city.toLowerCase().includes(q) ||
        s.district.toLowerCase().includes(q)
    );
    renderStores();
};

function renderStores() {
    document.getElementById("storeList").innerHTML =
        filtered.map(s => `
            <div class='store'>
                <b>${s.name}</b><br>
                ${s.city} / ${s.district}<br>
                ${s.address}<br>
                <small>${s.distance_km} km</small>
            </div>
        `).join("");
}

function createRoute() {
    if (filtered.length === 0) return alert("Mağaza bulunamadı.");

    const origin = `${stores[0].latitude},${stores[0].longitude}`;
    const destination = `${filtered[filtered.length-1].latitude},${filtered[filtered.length-1].longitude}`;

    const waypoints = filtered.slice(1, -1).map(s =>
        `${s.latitude},${s.longitude}`
    );

    const url =
        "https://www.google.com/maps/dir/?api=1" +
        `&origin=${origin}` +
        `&destination=${destination}` +
        `&waypoints=optimize:true|${waypoints.join("|")}`;

    window.open(url, "_blank");
}

loadStores();
</script>

</body>
</html>
